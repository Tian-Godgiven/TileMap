[toc]

# 在线交互服务

实现了系统设计中服务器为客户端提供的在线交互功能，以下是一部分重要功能的实现：

## 用户系统

（1）身份验证：服务器通过Mysql2中间件访问数据库，将存储数据与用户输入进行比较，实现了独立于客户端的登录用户的身份验证。此外，在注册保存用户密码时，除了服务端使用的固定秘钥，还额外使用了用户邮箱作为加密值，以生成独一的哈希密码与哈希盐，在进行身份验证时，会将用户输入的密码重新加密，与存储的哈希密码比对，从而判断身份验证。

 

![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml16932\wps58.png)

 

用户信息的泄露在很长一段时间都是各大应用服务的痛点，而哈希密码能有效解决此类问题。哈希密码的不可逆性断绝了密码逆向破解的威胁，将服务端内部定义hash_key与用户邮箱结合，更是进一步降低碰撞破解的可能性，即使数据库信息泄露，也不会造成用户重要信息的流出。

（2）邮箱验证：通过Node.js中的Nodemailer中间件提供的邮箱控制组件，实现了为注册用户和密码找回发送邮箱验证码服务。

 

![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml16932\wps59.png)

 

近年来，随着移动设备的普及，使用手机短信验证码成为了身份验证的热门趋势。毕竟电子邮箱在我国的普及率远低于手机号，邮箱验证码使用起来相较于短信验证码也更为繁琐，并且一位用户可以多持邮箱，而手机号的数量往往没有这么多。

不过，本软件仍然采用了邮箱注册的方式。其中部分原因当时因为邮箱注册的插件更加完善，使用起来也更加简便。另一部分原因则是考虑到本软件的定位倾向于本地工作，注册邮箱仅用于身份验证，而绝大部分情况下，手机号泄露给用户带来的困扰远大于邮箱泄露。在权衡利弊以及我们的数据库安全性后，邮箱注册成为了较优选项。

## 文件的上传与下载

通过Node.js中的fs中间件与MySQL数据库的记录路径，为登录用户提供文件管理服务。登录用户可以向服务器上传和下载指定类型的应用文件。值得一提的是，通过客户端上传至服务器的文件仅限当前被应用程序正确解析并加载的集合文件或工程文件。通过这种限制避免了用户随意上传文件，恶意占用服务器资源。

 

![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml16932\wps60.png)

 

​	不同用户的数据被保存在服务端数据存储系统中的专门的文件夹中，细化管理方式。在出现异常时，服务端可以通过查看这些数据文件，进行初步的问题筛查。也可以在特殊情况下通过服务端的文件管理系统为用户提供服务。

## 在线房间

（1）占有权限：当在线房间中的一名拥有思维导图修改权限的用户选中一个未被占有的对象时，将会向服务器发送一个占有请求，服务器在受到请求时，会在判断，服务器将该请求广播到其他用户的客户端，将这个对象的状态修改为occupied，其他用户此时便无法修改这个对象，从而解决同时修改产生的互斥问题。此外，服务端接的占有请求还会暂时存储在服务器缓存中，在同时受到不同用户对同一对象的占有请求时，会依据缓存数据的存储先后来判定占有权的归属。

 

![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml16932\wps61.png)

 

该功能的实现过程中使用了大量的async异步操作，在一定程度上会影响用户的使用流畅性，但这是权衡了安全性与需求实现后做出的妥协。如果不使用异步函数保障操作可行性，在实时通信的过程中，一个操作冲突会在极短的时间内扩散给所有连接中的用户，导致大面积的应用程序卡死或崩溃，这是提供在线服务必须避免的最差情况。

（2）同步显示与撤销重做：通过webSocket插件提供的实时通信连接功能，与在线房间连接的每个用户对思维导图的修改操作都会将修改对象的状态通过服务器广播给其他用户，并在这些用户的本地客户端修改这个对象的状态，以此实现同步显示。
	然而，只有进行修改操作的这个用户，才会将这个操作保存在本地的撤销栈中，因此，在线房间中的用户执行撤销操作时，只会将自己进行的修改操作撤销，不会也无法影响其他用户的操作。以此为准则，当两个用户连续对同一个对象进行修改后，较早进行修改的用户的撤销栈中的对象数据会被清除，便不能将这个已经被他人修改过的对象进行撤销，返回其在自己修改前的状态。

 

![img](file:///C:\Users\ADMINI~1\AppData\Local\Temp\ksohtml16932\wps62.png)

 

​		通过这样的设置，在保留撤销重做功能的同时，也避免了不同用户进行的操作相互干扰。并且通过sokect通信传递的仅是对一个对象的操作信息，而非画布整体的修改信息，降低了对服务器流量的需求。然而，该功能存在着不完善之处，即管理员并不具备对其他用户已进行的操作的管理能力，只能够在特殊的时间节点保存备份工程文件。该功能的优化需要将所有用户的操作记录在一个日志文件中，并提供按照日志记录逆向回溯到指定位置的功能。

# 数据库的实现

在本软件实现并使用的数据表与设计阶段的数据库表一致，具体内容请参见上方表1至表5。

数据库与服务端通过Node.js中间件mysql2连接，在文件中设定对应的数据库账户身份以获取对数据库增删查改操作的权限，该权限仅被分配给服务器管理员。

mysql2中间件能够通过.query()方法与指定的MySQL数据库相连，并在其中执行设置的SQL语句，在正确执行的情况下，会以数组结构返回对应的“列名：属性”对象作为执行结果，mysql2中间件的对异步逻辑的支持使其在请求响应的过程中能够更精确地控制返回信息，从而将处理结果更准确地展示给用户。

 